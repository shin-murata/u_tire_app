{% extends "base.html" %}

{% block content %}
<div class="container my-4">
    <h5>å‡ºåº«æŒ‡ç¤ºæ›¸</h5>
   <!-- å…±é€šãƒ‡ãƒ¼ã‚¿ -->
    <div class="tire-confirmation">
        <h5>å…±é€šãƒ‡ãƒ¼ã‚¿</h5>
        <div class="tire-form border p-3 bg-light d-flex flex-column align-items-stretch flex-grow-1" style="min-height: auto;">
            <div class="form-group data-rows d-flex flex-column flex-md-row align-items-stretch justify-content-between w-100 flex-grow-1" style="height: 100%; min-height: inherit;">
                <div class="data-group data-group-1 d-flex align-items-center flex-grow-1" style="height: 100%;">
                    <input type="hidden" name="width" value="{{ tires_to_dispatch[0].width_ref.value }}">
                    <p id="width" class="value m-0" style="height: 100%;">{{ tires_to_dispatch[0].width_ref.value }}</p>
                    <span class="separator mx-2">/</span>
                    <input type="hidden" name="aspect_ratio" value="{{ tires_to_dispatch[0].aspect_ratio_ref.value }}">
                    <p id="aspect_ratio" class="value m-0" style="height: 100%;">{{ tires_to_dispatch[0].aspect_ratio_ref.value }}</p>
                </div>
                <div class="data-group data-group-2 d-flex align-items-center flex-grow-1 mt-2 mt-md-0" style="height: 100%;">
                    <span class="prefix">R</span>
                    <input type="hidden" name="inch" value="{{ tires_to_dispatch[0].inch_ref.value }}">
                    <p id="inch" class="value m-0 mx-2" style="height: 100%;">{{ tires_to_dispatch[0].inch_ref.value }}</p>
                    <input type="hidden" name="ply_rating" value="{{ tires_to_dispatch[0].ply_rating_ref.value }}">
                    <p id="ply_rating" class="value m-0" style="height: 100%;">{{ tires_to_dispatch[0].ply_rating_ref.value }}</p>
                </div>
            </div>
        </div>
    </div>


    
    <!-- å€‹åˆ¥ãƒ‡ãƒ¼ã‚¿ -->
    <div class="d-flex justify-content-between align-items-center mt-4 mb-2">
        <h5 class="mb-0">å€‹åˆ¥ãƒ‡ãƒ¼ã‚¿</h5>
        <span class="dispatch-date-text">å‡ºåº«æ—¥: {{ dispatch_date|datetime_jp if dispatch_date else 'N/A' }}</span>
    </div>
    
    <div class="table-responsive">
        <table class="table table-bordered table-striped table-striped table-hover">
            <thead class="thead-light">
                <tr>
                    <th>åœ¨åº«ç•ªå·</th>
                    <th>ãƒ¡ãƒ¼ã‚«ãƒ¼</th>
                    <th>è£½é€ å¹´</th>
                    <th>æº</th>
                    <th>ç‰‡æ¸›ã‚Š</th>
                    <th>ãƒ—ãƒ©ã‚¤</th>
                    <th>ãã®ä»–ã®è©³ç´°</th>
                    <th>ä¾¡æ ¼</th>
                </tr>
            </thead>
            <tbody>
                {% for tire in tires_to_dispatch %}
                <tr>
                    <td>{{ tire.id }}</td>
                    <td>{{ tire.manufacturer_ref.name }}</td>
                    <td>{{ tire.manufacturing_year }}</td>
                    <td>{{ tire.tread_depth }}</td>
                    <td>{{ tire.uneven_wear }}</td>
                    <td>{{ tire.ply_rating_ref.value }}</td>
                    <td>{{ tire.other_details }}</td>
                    <td style="text-align: right;">{{ tire.price|currency }}</td>
                </tr>
                {% endfor %}
                <tr>
                    <td colspan="7" style="text-align: right;"><strong>åˆè¨ˆæœ¬æ•°:</strong></td>
                    <td style="text-align: right;">{{ total_tires }}</td>
                </tr>
                <tr>
                    <td colspan="7" style="text-align: right;"><strong>é‡‘é¡åˆè¨ˆ (ç¨æŠœ):</strong></td>
                    <td style="text-align: right;">{{ total_price|currency }}</td>
                </tr>
                <tr>
                    <td colspan="7" style="text-align: right;"><strong>æ¶ˆè²»ç¨ (10%):</strong></td>
                    <td style="text-align: right;">{{ tax|currency }}</td>
                </tr>
                <tr>
                    <td colspan="7" style="text-align: right; font-weight: bold;"><strong>åˆè¨ˆé‡‘é¡ (ç¨è¾¼):</strong></td>
                    <td style="text-align: right; font-weight: bold; color: #007bff;">{{ total_price_with_tax|currency }}</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- PDFç”Ÿæˆãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœã‚¿ãƒ³ -->
    <form id="pdfForm">
        <button id="pdf-button" type="button" class="btn btn-info">æŒ‡ç¤ºæ›¸ã‚’PDFã§å°åˆ·</button>
    </form>
    <!-- âœ… ã‚¹ãƒ”ãƒŠãƒ¼ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºç”¨ã®é ˜åŸŸ -->
    <div id="pdf-status" class="mt-3" style="display: none;">
        <div class="d-flex align-items-center">
            <!-- ã‚¹ãƒ”ãƒŠãƒ¼ï¼ˆBootstrapã®ã‚¯ãƒ©ã‚¹ã‚’åˆ©ç”¨ï¼‰ -->
            <div class="spinner-border text-primary mr-2" role="status" style="width: 1.5rem; height: 1.5rem;"></div>
            <!-- ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
            <strong>PDFã‚’ç”Ÿæˆä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„...</strong>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const pdfButton = document.getElementById("pdf-button");

        pdfButton.addEventListener("click", async function () {
            // âœ… æ–°ã—ã„ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‹ãã€ä»®ã®HTMLã‚’æ›¸ãè¾¼ã‚€
            const newTab = window.open("", "_blank");
            if (!newTab) {
                alert("ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
                return;
            }

            // âœ… ä¸€æ™‚è¡¨ç¤ºã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            newTab.document.write(`
                <html>
                    <head><title>PDFã‚’ç”Ÿæˆä¸­...</title></head>
                    <body style="font-family: sans-serif; text-align: center; padding-top: 50px;">
                        <div>
                            <div class="spinner" style="
                                border: 8px solid #f3f3f3;
                                border-top: 8px solid #007bff;
                                border-radius: 50%;
                                width: 60px;
                                height: 60px;
                                animation: spin 1s linear infinite;
                                margin: 0 auto 20px auto;
                            "></div>
                            <p>ğŸ“„ PDFã‚’ç”Ÿæˆä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„...</p>
                        </div>
                        <style>
                            @keyframes spin {
                                0% { transform: rotate(0deg); }
                                100% { transform: rotate(360deg); }
                            }
                        </style>
                    </body>
                </html>
            `);
            newTab.document.close();  // âœ… æ›¸ãè¾¼ã¿ã‚’å®Œäº†

            try {
                const response = await fetch("/send_to_gas", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({})
                });

                const result = await response.json();

                if (result.status === "success" && result.pdf_url) {
                    // âœ… PDFã«ç½®ãæ›ãˆã‚‹
                    newTab.location.href = result.pdf_url;
                } else {
                    newTab.document.body.innerHTML = "<p style='color:red;'>PDFã®URLãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚</p>";
                }
            } catch (err) {
                console.error("ã‚¨ãƒ©ãƒ¼:", err);
                newTab.document.body.innerHTML = "<p style='color:red;'>é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</p>";
            }
        });
    });

</script>
{% endblock %}
