{% extends "base.html" %}

{% block content %}
<div class="container my-4">
    <h5>å‡ºåº«æŒ‡ç¤ºæ›¸</h5>
   <!-- å…±é€šãƒ‡ãƒ¼ã‚¿ -->
    <div class="tire-confirmation">
        <h5>å…±é€šãƒ‡ãƒ¼ã‚¿</h5>
        <div class="tire-form border p-3 bg-light d-flex flex-column align-items-stretch flex-grow-1" style="min-height: auto;">
            <div class="form-group data-rows d-flex flex-column flex-md-row align-items-stretch justify-content-between w-100 flex-grow-1" style="height: 100%; min-height: inherit;">
                <div class="data-group data-group-1 d-flex align-items-center flex-grow-1" style="height: 100%;">
                    <input type="hidden" name="width" value="{{ tires_to_dispatch[0].width_ref.value }}">
                    <p id="width" class="value m-0" style="height: 100%;">{{ tires_to_dispatch[0].width_ref.value }}</p>
                    <span class="separator mx-2">/</span>
                    <input type="hidden" name="aspect_ratio" value="{{ tires_to_dispatch[0].aspect_ratio_ref.value }}">
                    <p id="aspect_ratio" class="value m-0" style="height: 100%;">{{ tires_to_dispatch[0].aspect_ratio_ref.value }}</p>
                </div>
                <div class="data-group data-group-2 d-flex align-items-center flex-grow-1 mt-2 mt-md-0" style="height: 100%;">
                    <span class="prefix">R</span>
                    <input type="hidden" name="inch" value="{{ tires_to_dispatch[0].inch_ref.value }}">
                    <p id="inch" class="value m-0 mx-2" style="height: 100%;">{{ tires_to_dispatch[0].inch_ref.value }}</p>
                    <input type="hidden" name="ply_rating" value="{{ tires_to_dispatch[0].ply_rating_ref.value }}">
                    <p id="ply_rating" class="value m-0" style="height: 100%;">{{ tires_to_dispatch[0].ply_rating_ref.value }}</p>
                </div>
            </div>
        </div>
    </div>


    
    <!-- å€‹åˆ¥ãƒ‡ãƒ¼ã‚¿ -->
    <div class="d-flex justify-content-between align-items-center mt-4 mb-2">
        <h5 class="mb-0">å€‹åˆ¥ãƒ‡ãƒ¼ã‚¿</h5>
        <span class="dispatch-date-text">å‡ºåº«æ—¥: {{ dispatch_date }}</span>  {# ã“ã¡ã‚‰ã®ã¿æ®‹ã™ #}
    </div>
    
    <div class="table-responsive">
        <table class="table table-bordered table-striped table-striped table-hover">
            <thead class="thead-light">
                <tr>
                    <th>åœ¨åº«ç•ªå·</th>
                    <th>ãƒ¡ãƒ¼ã‚«ãƒ¼</th>
                    <th>è£½é€ å¹´</th>
                    <th>æº</th>
                    <th>ç‰‡æ¸›ã‚Š</th>
                    <th>ãƒ—ãƒ©ã‚¤</th>
                    <th>ãã®ä»–ã®è©³ç´°</th>
                    <th>ä¾¡æ ¼</th>
                </tr>
            </thead>
            <tbody>
                {% for tire in tires_to_dispatch %}
                <tr>
                    <td>{{ tire.id }}</td>
                    <td>{{ tire.manufacturer_ref.name }}</td>
                    <td>{{ tire.manufacturing_year }}</td>
                    <td>{{ tire.tread_depth }}</td>
                    <td>{{ tire.uneven_wear }}</td>
                    <td>{{ tire.ply_rating_ref.value }}</td>
                    <td>{{ tire.other_details }}</td>
                    <td style="text-align: right;">{{ tire.price|currency }}</td>
                </tr>
                {% endfor %}
                <tr>
                    <td colspan="7" style="text-align: right;"><strong>åˆè¨ˆæœ¬æ•°:</strong></td>
                    <td style="text-align: right;">{{ total_tires }}</td>
                </tr>
                <tr>
                    <td colspan="7" style="text-align: right;"><strong>é‡‘é¡åˆè¨ˆ (ç¨æŠœ):</strong></td>
                    <td style="text-align: right;">{{ total_price|currency }}</td>
                </tr>
                <tr>
                    <td colspan="7" style="text-align: right;"><strong>æ¶ˆè²»ç¨ (10%):</strong></td>
                    <td style="text-align: right;">{{ tax|currency }}</td>
                </tr>
                <tr>
                    <td colspan="7" style="text-align: right; font-weight: bold;"><strong>åˆè¨ˆé‡‘é¡ (ç¨è¾¼):</strong></td>
                    <td style="text-align: right; font-weight: bold; color: #007bff;">{{ total_price_with_tax|currency }}</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- PDFç”Ÿæˆãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœã‚¿ãƒ³ -->
    <form id="pdfForm">
        <button type="submit" class="btn btn-info">æŒ‡ç¤ºæ›¸ã‚’PDFã§å°åˆ·</button>
    </form>    
</div>

<!-- JavaScript éƒ¨åˆ† -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        console.log("ğŸš€ DOMãŒå®Œå…¨ã«èª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ");

        let pdfForm = document.getElementById("pdfForm");
        if (!pdfForm) {
            console.error("âŒ `pdfForm` ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ JavaScript ã®å®Ÿè¡Œå‰ã« HTML ãŒå®Œå…¨ã«ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã™ã‹ï¼Ÿ");
            return;
        }

        console.log("âœ… `pdfForm` ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ:", pdfForm);

        pdfForm.addEventListener("submit", function(event) {
            event.preventDefault();  // ãƒšãƒ¼ã‚¸é·ç§»ã‚’é˜²ã
            console.log("ğŸš€ `fetch()` ã‚’å®Ÿè¡Œã—ã¾ã™...");

            var url = "https://script.google.com/macros/s/AKfycbwaO91xHAKW1sG5DUc8TUv8Qe_w0i6V7vt_qruMZwlPByD0afh_Or6u7Y9p--Z1irZu/exec";
            var data = {
                message: "PDFå°åˆ·ãƒªã‚¯ã‚¨ã‚¹ãƒˆ",
                dispatch_date: "{{ dispatch_date }}",
                tires: []  // åˆæœŸå€¤ã¨ã—ã¦ç©ºã®é…åˆ—
            };

            let tireElements = document.querySelectorAll(".copied-tire-form");
            if (tireElements.length === 0) {
                console.warn("âš ï¸ `copied-tire-form` ã®è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™ã€‚");
            } else {
                tireElements.forEach(tire => {
                    let tireData = {
                        id: tire.querySelector('[name="id"]')?.value || "N/A",
                        manufacturer: tire.querySelector('[name="manufacturer[]"]')?.value || "N/A",
                        manufacturing_year: tire.querySelector('[name="manufacturing_year[]"]')?.value || "N/A",
                        tread_depth: tire.querySelector('[name="tread_depth[]"]')?.value || "N/A",
                        uneven_wear: tire.querySelector('[name="uneven_wear[]"]')?.value || "N/A",
                        ply_rating: tire.querySelector('[name="ply_rating[]"]')?.value || "N/A",
                        other_details: tire.querySelector('[name="other_details[]"]')?.value || "N/A",
                        price: tire.querySelector('[name="price"]')?.value || "N/A"
                    };
                    data.tires.push(tireData);
                });
            }

            data.total_tires = "{{ total_tires }}";
            data.total_price = "{{ total_price }}";
            data.tax = "{{ tax }}";
            data.total_price_with_tax = "{{ total_price_with_tax }}";

            console.log("ğŸ“¦ é€ä¿¡ãƒ‡ãƒ¼ã‚¿:", JSON.stringify(data, null, 2));  // é€ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª

            fetch(url, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                mode: "cors",
                body: JSON.stringify(data)
            })
            .then(response => {
                console.log("ğŸ“¥ `fetch()` ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å—ä¿¡:", response);
                console.log("ğŸ” ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰:", response.status);
                console.log("ğŸ” ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼:", [...response.headers.entries()]);

                if (!response.ok) {
                    throw new Error("HTTPã‚¨ãƒ©ãƒ¼, ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: " + response.status);
                }
                return response.text();
            })
            .then(result => {
                console.log("âœ… `fetch()` æˆåŠŸ:", result);
                alert("ğŸ“„ PDFç”Ÿæˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¾ã—ãŸï¼");
            })
            .catch(error => {
                console.error("âŒ `fetch()` ã‚¨ãƒ©ãƒ¼:", error);
                alert("âš ï¸ é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸï¼");
            });
        });
    });
</script>    
{% endblock %}
